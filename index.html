<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVL Tournament System v1.4 (Crystal Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            
            --survivor-grad: linear-gradient(45deg, #2b5876 0%, #4e4376 100%);
            --hunter-grad: linear-gradient(45deg, #870000 0%, #190a05 100%);
            
            --btn-ban: linear-gradient(45deg, #cb2d3e, #ef473a);
            --btn-pick: linear-gradient(45deg, #1fa2ff, #12d8fa, #a6ffcb);
            --btn-map: linear-gradient(45deg, #ffd700, #fdb931);
            
            --global-ban-bg: rgba(147, 112, 219, 0.25); /* æ·¡ç´«è‰² */
            --global-ban-border: #9370db;
            
            --text-gold: #f1c40f;
            --text-silver: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-silver);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- æ°´æ™¶å¡ç‰‡é€šç”¨æ¨£å¼ --- */
        .crystal-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
        }

        /* --- é ‚éƒ¨è¨­ç½®èˆ‡è¨˜åˆ†æ¿ --- */
        .header-panel {
            width: 100%; max-width: 1300px; padding: 20px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .team-inputs { display: flex; gap: 20px; align-items: center; }
        .fancy-input {
            background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff;
            padding: 10px 15px; border-radius: 8px; font-size: 1.1rem; outline: none;
        }
        
        .scoreboard {
            display: flex; gap: 30px; align-items: center;
            font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--text-gold);
        }
        .score-box { text-align: center; }
        .score-num { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(241,196,15,0.5); }

        /* --- ç‹€æ…‹é¡¯ç¤º --- */
        .status-bar {
            width: 100%; max-width: 1200px; padding: 15px; margin-bottom: 20px;
            text-align: center; font-size: 1.5rem; font-weight: bold;
            color: #fff; border-bottom: 2px solid var(--text-gold);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- éŠæˆ²ä¸»å€åŸŸ --- */
        .main-stage { width: 100%; max-width: 1300px; display: none; flex-direction: column; gap: 20px; }
        
        .phase-info {
            text-align: center; font-family: 'Great Vibes', cursive; 
            font-size: 2.5rem; color: rgba(255,255,255,0.8); margin: 10px 0;
        }

        .faction-container { display: flex; gap: 20px; }
        .faction-box { flex: 1; padding: 20px; position: relative; overflow: hidden; }
        
        /* é™£ç‡Ÿæ¨™é¡Œ */
        .faction-title {
            font-family: 'Great Vibes', cursive; font-size: 3rem; text-align: center; margin-bottom: 20px;
            background: -webkit-linear-gradient(#eee, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .hunter-title { background: var(--hunter-grad); -webkit-background-clip: text; }
        .survivor-title { background: var(--survivor-grad); -webkit-background-clip: text; }

        .team-badge {
            font-family: 'Cinzel', serif; font-size: 1.2rem; text-align: center; 
            margin-bottom: 15px; letter-spacing: 2px; color: var(--text-gold);
        }

        /* --- ç¶²æ ¼èˆ‡æŒ‰éˆ• --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        
        .item-card {
            padding: 12px 5px; text-align: center; border-radius: 8px; cursor: pointer;
            font-size: 0.9rem; font-weight: 500; user-select: none;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        /* æ‡¸æµ®æ¼¸è®Š */
        .item-card:hover:not(.disabled) {
            transform: translateY(-3px) scale(1.05);
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.5);
            z-index: 10;
        }

        /* ç‹€æ…‹è‰²å½© */
        .item-card.active-ban { background: var(--btn-ban); color: white; border: none; box-shadow: 0 0 15px rgba(203, 45, 62, 0.6); }
        .item-card.active-pick { background: var(--btn-pick); color: #003366; border: none; box-shadow: 0 0 15px rgba(18, 216, 250, 0.6); }
        .item-card.active-map { background: var(--btn-map); color: #4a3b00; border: none; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }

        /* å…¨å±€ç¦ç”¨ (æ·¡ç´«è‰²) */
        .item-card.global-banned {
            background: var(--global-ban-bg);
            border: 1px solid var(--global-ban-border);
            color: #d8b4e2;
            cursor: not-allowed;
            pointer-events: none;
        }
        .item-card.global-banned::after { content: "ğŸ”’"; position: absolute; top: 2px; right: 2px; font-size: 10px; }

        /* ä¸€èˆ¬ç¦ç”¨/é–å®š */
        .item-card.locked { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }

        /* --- åº•éƒ¨æ§åˆ¶ --- */
        .control-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; padding: 15px; display: flex; gap: 10px; justify-content: center;
            z-index: 100;
        }

        .btn-action {
            padding: 12px 30px; border-radius: 30px; border: none; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            background: #fff; color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: 0.2s;
        }
        .btn-start { background: var(--text-gold); color: #000; }
        .btn-confirm { background: #00b09b; background: linear-gradient(to right, #00b09b, #96c93d); color: white; display: none; }
        
        /* æ¯”åˆ†è¼¸å…¥ Modal */
        .score-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;
        }
        .modal-content {
            padding: 40px; text-align: center; width: 400px;
        }
        .modal-input {
            width: 80px; padding: 10px; font-size: 1.5rem; text-align: center; margin: 10px;
            border-radius: 8px; border: none;
        }
    </style>
</head>
<body>

    <div class="header-panel crystal-card" id="headerPanel">
        <div class="team-inputs" id="setupZone">
            <input type="text" id="teamA_Input" class="fancy-input" value="Wolves" placeholder="ä¸»å ´æˆ°éšŠ">
            <span style="color:#aaa">VS</span>
            <input type="text" id="teamB_Input" class="fancy-input" value="Gr" placeholder="å®¢å ´æˆ°éšŠ">
            <button class="btn-action btn-start" onclick="initTournament()">Start Match</button>
        </div>
        
        <div class="scoreboard" id="scoreZone" style="display:none;">
            <div class="score-box">
                <div id="displayTeamA">Team A</div>
                <div class="score-num" id="scoreA">0</div>
            </div>
            <div style="font-size:1rem; opacity:0.7">BO<span id="boDisplay">1</span> - Round <span id="roundDisplay">1</span><br><span id="halfDisplay">UP</span></div>
            <div class="score-box">
                <div id="displayTeamB">Team B</div>
                <div class="score-num" id="scoreB">0</div>
            </div>
        </div>
    </div>

    <div class="status-bar" id="statusBar">Welcome to IVL BP System</div>

    <div class="main-stage" id="mapStage">
        <div class="phase-info">Map Phase</div>
        <div class="crystal-card faction-box">
            <div class="team-badge" id="mapPickerName">Map Picker: ???</div>
            <div class="grid" id="mapGrid"></div>
        </div>
    </div>

    <div class="main-stage" id="charStage">
        <div class="phase-info">Ban & Pick Phase</div>
        <div class="faction-container">
            <div class="crystal-card faction-box" id="survBox">
                <div class="survivor-title">Survivors</div>
                <div class="team-badge" id="survTeamName">Team Name</div>
                <div class="grid" id="survGrid"></div>
            </div>
            <div class="crystal-card faction-box" id="huntBox">
                <div class="hunter-title">Hunters</div>
                <div class="team-badge" id="huntTeamName">Team Name</div>
                <div class="grid" id="huntGrid"></div>
            </div>
        </div>
    </div>

    <div class="crystal-card" style="width: 100%; max-width: 1300px; padding: 15px; margin-top: 20px; font-family: monospace; color: #0f0; min-height: 50px; white-space: pre-wrap;" id="logArea"></div>

    <div class="control-dock crystal-card">
        <button class="btn-action btn-confirm" id="confirmBtn" onclick="nextStep()">Confirm</button>
    </div>

    <div class="score-modal" id="scoreModal">
        <div class="crystal-card modal-content">
            <h2 style="color:var(--text-gold)">End of Half</h2>
            <p>è«‹è¼¸å…¥æœ¬åŠå ´ç©åˆ†</p>
            <div>
                <label id="labelA">A</label>: <input type="number" id="inputScoreA" class="modal-input" value="0">
            </div>
            <div>
                <label id="labelB">B</label>: <input type="number" id="inputScoreB" class="modal-input" value="0">
            </div>
            <button class="btn-action btn-start" style="margin-top:20px" onclick="submitScore()">Next Half / Round</button>
        </div>
    </div>

    <script>
        // === æ•¸æ“šåº« ===
        const maps = ["è»å·¥å» ","ç´…æ•™å ‚","è–å¿ƒé†«é™¢","æ¹–æ™¯æ‘","æœˆäº®æ²³å…¬åœ’","é‡Œå¥§çš„å›æ†¶","æ°¸çœ é®","å”äººè¡—","ä¸æ­¸æ—"];
        const survivors = [
            "å¹¸é‹å…’","é†«ç”Ÿ","å¾‹å¸«","æ…ˆå–„å®¶","åœ’ä¸","é­”è¡“å¸«","å†’éšªå®¶","å‚­å…µ","ç©ºè»","æ©Ÿæ¢°å¸«",
            "å‰é‹’","ç›²å¥³","ç¥­å¸","èª¿é¦™å¸«","ç‰›ä»”","èˆå¥³","å…ˆçŸ¥","å…¥æ®®å¸«","å‹˜æ¢å“¡","å’’è¡“å¸«",
            "é‡äºº","é›œæŠ€æ¼”å“¡","å¤§å‰¯","èª¿é…’å¸«","éƒµå·®","å®ˆå¢“äºº","å›šå¾’","æ˜†èŸ²å­¸è€…","ç•«å®¶",
            "æ“Šçƒæ‰‹","ç©å…·å•†","ç—…æ‚£","å¿ƒç†å­¸å®¶","å°èªªå®¶","å°å¥³å­©","å“­æ³£å°ä¸‘","æ•™æˆ",
            "å¤è‘£å•†","ä½œæ›²å®¶","è¨˜è€…","é£›è¡Œå®¶","æ‹‰æ‹‰éšŠå“¡","æœ¨å¶å¸«","ç«ç½èª¿æŸ¥å“¡","æ³•ç¾…å¥³å£«",
            "é¨å£«","æ°£è±¡å­¸å®¶","å¼“ç®­æ‰‹","é€ƒè„«å¤§å¸«","å¹»ç‡ˆå¸«","é¬¥ç‰›å£«"
        ];
        const hunters = [
            "å» é•·","å‚‘å…‹","å°ä¸‘","é¹¿é ­","èœ˜è››","ç´…è¶","é»ƒè¡£ä¹‹ä¸»","å®¿å‚˜ä¹‹é­‚","æ”å½±å¸«",
            "å¤¢ä¹‹å¥³å·«","ç´…å¤«äºº","å°æç´å®¶","é›•åˆ»å®¶","åšå£«","ç ´è¼ª","æ¼å¥³","è Ÿåƒå¸«",
            "å™©å¤¢","è¨˜éŒ„å“¡","ä½¿å¾’","éš±å£«","å®ˆå¤œäºº","æ­ŒåŠ‡æ¼”å“¡","æ„šäººé‡‘","æ™‚ç©ºä¹‹å½±",
            "è·›è…³ç¾Š","å–§å›‚","å°çƒæ‰‹","é›œè²¨å•†"
        ];

        // === è³½äº‹ç‹€æ…‹ ===
        let matchState = {
            teamA: "", teamB: "",
            scoreA: 0, scoreB: 0,
            round: 1, // 1, 2, 3
            half: 0, // 0 = ä¸ŠåŠ, 1 = ä¸‹åŠ
            
            // å…¨å±€è¨˜éŒ„
            usedMaps: [],
            teamA_UsedSurv: [],
            teamB_UsedSurv: [],
            
            // ç•¶å‰å±€ç‹€æ…‹
            mapPicker: "", 
            hunterTeam: "", 
            survivorTeam: "",
            currentMap: "",
            
            // æµç¨‹æ§åˆ¶
            phase: 'idle', // idle, mapBan, mapPick, charBP
            flow: [],
            stepIdx: 0,
            selection: []
        };

        // === 1. åˆå§‹åŒ–èˆ‡å•Ÿå‹• ===
        function initTournament() {
            matchState.teamA = document.getElementById('teamA_Input').value || "Team A";
            matchState.teamB = document.getElementById('teamB_Input').value || "Team B";
            
            // UI åˆ‡æ›
            document.getElementById('setupZone').style.display = 'none';
            document.getElementById('scoreZone').style.display = 'flex';
            document.getElementById('displayTeamA').innerText = matchState.teamA;
            document.getElementById('displayTeamB').innerText = matchState.teamB;
            
            startNewHalf();
        }

        function startNewHalf() {
            // æ›´æ–°è¨ˆåˆ†æ¿é¡¯ç¤º
            document.getElementById('boDisplay').innerText = matchState.round;
            document.getElementById('roundDisplay').innerText = matchState.round;
            document.getElementById('halfDisplay').innerText = matchState.half === 0 ? "Top (ä¸ŠåŠ)" : "Bot (ä¸‹åŠ)";
            
            // æ±ºå®šèº«åˆ† (è¦å‰‡å¼•æ“)
            determineSides();
            
            // æº–å‚™é€²å…¥æµç¨‹
            // å¦‚æœæ˜¯ä¸ŠåŠå ´ï¼Œå…ˆé€²è¡Œåœ°åœ– BPã€‚å¦‚æœæ˜¯ä¸‹åŠå ´ï¼Œç›´æ¥ç¹¼æ‰¿åœ°åœ–ï¼Œåªé€²è¡Œæ›é‚Šè§’è‰² BPã€‚
            if (matchState.half === 0) {
                initMapPhase();
            } else {
                initCharPhase();
            }
        }

        // è¦å‰‡å¼•æ“ï¼šæ±ºå®šèª°é¸åœ–ã€èª°æ˜¯ç›£ç®¡
        function determineSides() {
            // è¦å‰‡ 1: é¸åœ–æ¬Š (Map Picker)
            // BO1 & BO3: ä¸»å ´ (Team A) é¸åœ–ã€‚ BO2: å®¢å ´ (Team B) é¸åœ–ã€‚
            if (matchState.round === 1 || matchState.round === 3) {
                matchState.mapPicker = matchState.teamA;
            } else {
                matchState.mapPicker = matchState.teamB;
            }

            // è¦å‰‡ 2: é™£ç‡Ÿæ­¸å±¬ (Hunter / Survivor)
            // BO1 & BO3: ä¸ŠåŠå ´ä¸»å ´æ˜¯ç›£ç®¡ã€‚
            // BO2: ä¸ŠåŠå ´å®¢å ´æ˜¯ç›£ç®¡ (é€šå¸¸äº¤æ›ï¼Œé€™è£¡ä¾å¾ªä¸»å ´=BO1/3å„ªå‹¢çš„é‚è¼¯åæ¨)
            // ä¸‹åŠå ´ï¼šè‡ªå‹•äº’æ›
            
            let firstHalfHunter = (matchState.round === 1 || matchState.round === 3) ? matchState.teamA : matchState.teamB;
            
            if (matchState.half === 0) {
                matchState.hunterTeam = firstHalfHunter;
                matchState.survivorTeam = (firstHalfHunter === matchState.teamA) ? matchState.teamB : matchState.teamA;
            } else {
                matchState.hunterTeam = (firstHalfHunter === matchState.teamA) ? matchState.teamB : matchState.teamA;
                matchState.survivorTeam = firstHalfHunter;
            }

            logMsg(`>>> Round ${matchState.round} - ${matchState.half===0?'Top':'Bottom'} Start.`);
            logMsg(`Map Picker: ${matchState.mapPicker} | Hunter: ${matchState.hunterTeam} vs Survivor: ${matchState.survivorTeam}`);
        }

        // === 2. åœ°åœ–éšæ®µ ===
        function initMapPhase() {
            matchState.phase = 'map';
            document.getElementById('mapStage').style.display = 'flex';
            document.getElementById('charStage').style.display = 'none';
            document.getElementById('mapPickerName').innerText = `Picker: ${matchState.mapPicker}`;
            
            renderMapGrid();
            
            // æµç¨‹: ç¦1 -> é¸1
            matchState.flow = [
                { type: 'mapBan', msg: `è«‹ ${matchState.mapPicker} ç¦ç”¨ä¸€å¼µåœ°åœ–`, count: 1 },
                { type: 'mapPick', msg: `è«‹ ${matchState.mapPicker} é¸æ“‡æ¯”è³½åœ°åœ–`, count: 1 }
            ];
            matchState.stepIdx = 0;
            updateUI();
        }

        function renderMapGrid() {
            const grid = document.getElementById('mapGrid');
            grid.innerHTML = '';
            maps.forEach(m => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerText = m;
                
                // å…¨å±€ç¦ç”¨åˆ¤æ–·
                if (matchState.usedMaps.includes(m)) {
                    div.classList.add('global-banned');
                }
                
                div.onclick = () => handleMapClick(div, m);
                grid.appendChild(div);
            });
        }

        function handleMapClick(div, name) {
            if (div.classList.contains('global-banned') || div.classList.contains('locked')) return;
            
            const step = matchState.flow[matchState.stepIdx];
            const isBan = step.type === 'mapBan';
            
            if (matchState.selection.includes(name)) {
                matchState.selection = [];
                div.classList.remove(isBan ? 'active-ban' : 'active-map');
            } else {
                // æ¸…é™¤å…¶ä»–
                document.querySelectorAll('#mapGrid .item-card').forEach(c => c.classList.remove('active-ban', 'active-map'));
                matchState.selection = [name];
                div.classList.add(isBan ? 'active-ban' : 'active-map');
            }
            checkConfirmBtn();
        }

        // === 3. è§’è‰² BP éšæ®µ ===
        function initCharPhase() {
            matchState.phase = 'charBP';
            document.getElementById('mapStage').style.display = 'none';
            document.getElementById('charStage').style.display = 'flex';
            
            document.getElementById('survTeamName').innerText = matchState.survivorTeam;
            document.getElementById('huntTeamName').innerText = matchState.hunterTeam;

            renderCharGrids();

            // æ§‹å»º BP æµç¨‹ (ä¾å±€æ•¸èª¿æ•´ Ban æ•¸)
            let survBanNum = 0;
            if (matchState.round === 2) survBanNum = 1;
            if (matchState.round >= 3) survBanNum = 2;

            matchState.flow = [
                { role: 'Hunter', action: 'Ban', count: 2, msg: 'Hunter Phase: Ban 2 Survivors' },
                { role: 'Survivor', action: 'Ban', count: survBanNum, msg: `Survivor Phase: Ban ${survBanNum} Hunter` },
                { role: 'Survivor', action: 'Pick', count: 2, msg: 'Survivor Phase: Pick 2 Survivors' },
                { role: 'Hunter', action: 'Ban', count: 2, msg: 'Hunter Phase: Ban 2 Survivors' },
                { role: 'Survivor', action: 'Pick', count: 2, msg: 'Survivor Phase: Pick 2 Survivors' },
                { role: 'Hunter', action: 'Pick', count: 1, msg: 'Hunter Phase: Pick 1 Hunter' }
            ].filter(s => s.count > 0);

            matchState.stepIdx = 0;
            updateUI();
        }

        function renderCharGrids() {
            // æ¸²æŸ“æ±‚ç”Ÿè€…
            const sGrid = document.getElementById('survGrid');
            sGrid.innerHTML = '';
            survivors.forEach(name => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerText = name;
                div.dataset.role = 'Survivor';
                div.dataset.name = name;
                
                // å…¨å±€ç¦ç”¨æª¢æŸ¥ (åƒ…æª¢æŸ¥æ±‚ç”Ÿè€…æ–¹å·²ä½¿ç”¨çš„)
                // é‚è¼¯ï¼šå¦‚æœæ˜¯æ±‚ç”Ÿè€…æ–¹ TeamAï¼Œæª¢æŸ¥ TeamA_UsedSurv
                const currentSurvTeam = matchState.survivorTeam;
                const usedList = (currentSurvTeam === matchState.teamA) ? matchState.teamA_UsedSurv : matchState.teamB_UsedSurv;
                
                if (usedList.includes(name)) {
                    div.classList.add('global-banned');
                }

                div.onclick = () => handleCharClick(div);
                sGrid.appendChild(div);
            });

            // æ¸²æŸ“ç›£ç®¡è€…
            const hGrid = document.getElementById('huntGrid');
            hGrid.innerHTML = '';
            hunters.forEach(name => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerText = name;
                div.dataset.role = 'Hunter';
                div.dataset.name = name;
                // ç›£ç®¡è€…é€šå¸¸ä¸é–å…¨å±€è§’è‰²ï¼Œé™¤éç‰¹å®šè¦å‰‡ï¼Œé€™è£¡å…ˆä¸é–
                div.onclick = () => handleCharClick(div);
                hGrid.appendChild(div);
            });
        }

        function handleCharClick(div) {
            if (div.classList.contains('global-banned') || div.classList.contains('locked')) return;
            
            const step = matchState.flow[matchState.stepIdx];
            
            // é©—è­‰é™£ç‡Ÿ
            let targetRole = (step.role === 'Hunter' && step.action === 'Ban') ? 'Survivor' : step.role; // ç›£ç®¡ Ban æ±‚ç”Ÿ
            if (step.role === 'Survivor' && step.action === 'Ban') targetRole = 'Hunter'; // æ±‚ç”Ÿ Ban ç›£ç®¡
            if (step.action === 'Pick') targetRole = step.role;

            if (div.dataset.role !== targetRole) return;

            const name = div.dataset.name;
            const activeClass = step.action === 'Ban' ? 'active-ban' : 'active-pick';

            if (matchState.selection.includes(name)) {
                matchState.selection = matchState.selection.filter(n => n !== name);
                div.classList.remove(activeClass);
            } else {
                if (matchState.selection.length < step.count) {
                    matchState.selection.push(name);
                    div.classList.add(activeClass);
                }
            }
            checkConfirmBtn();
        }

        // === 4. æµç¨‹æ§åˆ¶æ ¸å¿ƒ ===
        function updateUI() {
            const step = matchState.flow[matchState.stepIdx];
            const statusBar = document.getElementById('statusBar');
            
            statusBar.innerText = step.msg;
            matchState.selection = [];
            
            // è¦–è¦ºç„¦é»
            if (matchState.phase === 'charBP') {
                const sBox = document.getElementById('survBox');
                const hBox = document.getElementById('huntBox');
                sBox.style.opacity = '0.3'; hBox.style.opacity = '0.3';
                
                // åˆ¤æ–·ç•¶å‰æ“ä½œç›®æ¨™å€åŸŸ
                let targetIsSurv = (step.role === 'Hunter' && step.action === 'Ban') || (step.role === 'Survivor' && step.action === 'Pick');
                // ç‰¹æ®Šï¼šæ±‚ç”Ÿ Ban ç›£ç®¡ -> æ“ä½œç›£ç®¡å€
                if (step.role === 'Survivor' && step.action === 'Ban') targetIsSurv = false;
                if (step.role === 'Hunter' && step.action === 'Pick') targetIsSurv = false;

                if (targetIsSurv) sBox.style.opacity = '1';
                else hBox.style.opacity = '1';
            }

            checkConfirmBtn();
        }

        function checkConfirmBtn() {
            const step = matchState.flow[matchState.stepIdx];
            const btn = document.getElementById('confirmBtn');
            const count = matchState.selection.length;
            
            if (count === step.count) {
                btn.style.display = 'block';
                btn.innerText = "Confirm Selection";
            } else {
                btn.style.display = 'none';
            }
        }

        function nextStep() {
            const step = matchState.flow[matchState.stepIdx];
            
            // è™•ç†é–å®šé‚è¼¯
            if (matchState.phase === 'map') {
                const mName = matchState.selection[0];
                const card = Array.from(document.querySelectorAll('#mapGrid .item-card')).find(c => c.innerText === mName);
                card.classList.add('locked');
                card.classList.remove('active-ban', 'active-map');
                
                if (step.type === 'mapBan') {
                    card.style.background = 'var(--btn-ban)';
                    logMsg(`Map Ban: ${mName}`);
                } else {
                    card.style.background = 'var(--btn-map)';
                    logMsg(`Map Pick: ${mName}`);
                    matchState.usedMaps.push(mName); // åŠ å…¥å…¨å±€ç¦ç”¨
                    matchState.currentMap = mName;
                }

            } else {
                // è§’è‰²é‚è¼¯
                const actionColor = step.action === 'Ban' ? 'var(--btn-ban)' : 'var(--btn-pick)';
                logMsg(`${step.role} ${step.action}: ${matchState.selection.join(', ')}`);

                matchState.selection.forEach(name => {
                    // é–å®š UI
                    const cards = document.querySelectorAll(`.item-card[data-name="${name}"]`);
                    cards.forEach(c => {
                        c.classList.remove('active-ban', 'active-pick');
                        c.classList.add('locked');
                        c.style.background = actionColor;
                    });

                    // è™•ç†å…¨å±€ç¦ç”¨ (åƒ… Pick çš„æ±‚ç”Ÿè€…)
                    if (step.action === 'Pick' && step.role === 'Survivor') {
                        if (matchState.survivorTeam === matchState.teamA) matchState.teamA_UsedSurv.push(name);
                        else matchState.teamB_UsedSurv.push(name);
                    }
                });
            }

            // æ¨é€²
            matchState.stepIdx++;
            if (matchState.stepIdx < matchState.flow.length) {
                updateUI();
            } else {
                // éšæ®µçµæŸ
                if (matchState.phase === 'map') {
                    initCharPhase();
                } else {
                    showScoreModal();
                }
            }
        }

        // === 5. ç©åˆ†èˆ‡æ›å±€ ===
        function showScoreModal() {
            const modal = document.getElementById('scoreModal');
            document.getElementById('labelA').innerText = matchState.teamA;
            document.getElementById('labelB').innerText = matchState.teamB;
            document.getElementById('inputScoreA').value = 0;
            document.getElementById('inputScoreB').value = 0;
            modal.style.display = 'flex';
        }

        function submitScore() {
            const sa = parseInt(document.getElementById('inputScoreA').value) || 0;
            const sb = parseInt(document.getElementById('inputScoreB').value) || 0;
            
            matchState.scoreA += sa;
            matchState.scoreB += sb;
            
            // æ›´æ–° UI
            document.getElementById('scoreA').innerText = matchState.scoreA;
            document.getElementById('scoreB').innerText = matchState.scoreB;
            document.getElementById('scoreModal').style.display = 'none';

            logMsg(`=== End of Half. Score: ${matchState.teamA} ${sa} - ${sb} ${matchState.teamB} ===`);

            // æº–å‚™ä¸‹ä¸€å±€/åŠå ´
            if (matchState.half === 0) {
                matchState.half = 1;
            } else {
                matchState.half = 0;
                matchState.round++;
            }
            
            startNewHalf();
        }

        function logMsg(txt) {
            const area = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            area.innerText += `[${time}] ${txt}\n`;
            area.scrollTop = area.scrollHeight;
        }

    </script>
</body>
</html>
